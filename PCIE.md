
# Standards

## From PCI-SIG Standards


### MAC Layer Functions

||| Just for reference

from PCI-SIG standards with OSI architecture reference, MAC layer is generally responsible for:

+ Formation of Training sequence 1 (TS1) & Training Sequence 2 (TS2) packets
+ Formation of skip ordered set (SOS).
+ Formation of electrical idle ordered sets (EIOS).
+ Formation of fast training sequence ordered sets(FTSOS).
+ Formation of Logical idles.
+ Handling power management.

### Reference MAC Layer Archs

Based on functions depicted above, a reference MAC implementation constructed as follow.

#### TS1/2 formation 

 + generates training sequences that are required for training the link before setting up the link for sending the actual data (i.e TLP or DLLP)
 + generated training sequences are based on LTSSM's state, while LTSSM depends on inputed sequences for state transition
 
 
#### SOS formation
 
 + generated SOS packet
 
SOS is a packet containing the COM symbol followed by three SKP symbols. SOSs are sent anywhere in the interval of 1180 – 1538 symbols (See PCI-SIG std.). SOS prevents the overflow or underflow of the Elastic buffer present in the receiver PCS of each device.
 
#### EIOS formation

EIOS(Electrical IDLE Ordered Set) is a packet consisting of the COM symbol followed by three IDLE symbols. EIOSs are generated and sent by the Transmitter engine before it wants to move to low power states like L0s, L1 or L2. When the Transmitter engine sends EIOS, the configuration registers and contents of variables are stored to be loaded back when the device is restored back to active state L0. 

#### FTSOS formation

Fast training sequence is a packet consisting of a COM symbol followed by three FTS symbols. A certain number of FTS ordered sets are sent by the Transmitter engine of the device which is in low power state if it wants to come back to active state L0. The number of FTSOSs needed to be sent is decided by the N_FTS field present in TS1/TS2 [1].

#### Logical Idle module

Logical Idle symbols are just zeros sent as data. After LTSSM training is done before moving to active state the device needs to send and receive a certain number of logical idles.

#### Power Management module

Power Management module generates the power down signal based on the phystatus signal given by the SERDES.

#### Scrambler module


Arbiter Module: The main block of the MAC is the arbiter.
The arbiter module is capable of handling the requests
generated by the different packet formation modules.
Depending on the LTSSM state change one or the other packet
formation modules will make a bus request to arbiter and
arbiter grants the bus to one of those modules which has made
the request. The decision to grant the bus to packet formation
module is done by the internal artificial intelligence logic
incorporated into the arbiter module.
In order to achieve the low latency we have designed our
MAC unit in such a way that it follows pipelining all the time.
The bus request from packet formation module, the bus
arbitration, bus grant and sending of packets is done in two
initial clock cycles. Followed by which we get data for every
clock cycle.
If the bus is engaged by one module and if another module
makes the request for the bus to the arbiter, it will be held until
the bus becomes free. A “BUSY” signal will be generated by
the module which is engaged in sending packets on the bus, as
soon as the packets are sent the module will de-assert the
BUSY signal so immediately in the next clock cycle the bus
will be engaged by the other module without stalling. There is
no glitch or stalled cycle in the designed MAC architecture.
: The Scrambler is intended to prevent
repetitive patterns in data streams [1]. These repetitive patterns
create a pure tone i.e. a noise of high intensity around a
particular frequency which is much more than the noise
caused by EMI. For this reason PCI-SIG has included a
scrambler in the specification which is mandatory.
The Scrambler scrambles the data and logical idles, it
bypasses all the training sequences, ordered sets and
compliance patterns. The scrambler can be disabled for
compliance patterns externally by an implementation specific
signal. 


## From Intel's PIPE Spec

### Interface Summary

 + TX side
  - TxData: 8/16/32 bit width
  - TxD/K : Indicates whether packet is data/control
  - Commands group:
   + TxdetectRx   : Begin receiver detection
   + PipeWidth    : Indicates data width
   + PipeRate     : Indicates link speed
   + TxDataValid  : Indicates valid data is present
   + PwrDown      : Indicates various power management states
   + TxCompliance : For compliance pattern test
   + ResetPhy     : Physical layer reset signal
   
 + RX side
  - RxData : 8/16/32 bit width
  - RxD/K  : Indicates whether received packet is data/control character
  - Status group: 5 bit status signal from PHY to MAC
   + PHY obtained symbol lock
   + PHY completed various PM states
   + Received data is valid
   + PHY detected receiver
   + PHY detected Electrical Idle on link 

### Relationship between Phy clock rate and Link Speed

** GEN1 **

|  PIPE DATA WIDTH  |   PHY CLOCK RATE (MHz)  | LINK SPPED(GEN1) | 
| ----------------- | ------------------------------------------ | 
| 8                 | 250                     | 2.5 GT/s         | 
| 16                | 125                     | 2.5 GT/s         | 
| 32                | 62.5                    | 2.5 GT/s         | 

** GEN2 **

|  PIPE DATA WIDTH  |   PHY CLOCK RATE (MHz)  | LINK SPPED(GEN2) |
| ----------------- | ------------------------------------------ |
| 8                 | 250                     |  5 GT/s (GEN2)   |
| 16                | 125                     |  5 GT/s (GEN2)   |
| 32                | 62.5                    |  5 GT/s (GEN2)   |


#### Link Initialization and Training
It's a Physical Layer control process that configures and initializes a device’s Physical Layer, port and associated Link so that normal packet traffic can proceed on the Link.

 + This process is automatically initialized after reset without any software involvement
 + A sub-set of Link retraining is initiated automatically as a result of wake up event from a low power mode or due to an error condition that render the Link inoperable.
 + 


## Reference


### Element phase

[0] [Design Implementation of High Speed PCI using MAC Transmitter with PIPE Interface](https://www.atrialogic.com/pdf_file/ieee_atria_pcie_MACTx_pipe.pdf)

[1] [Link Initialization and Training in MAC Layer of PCIe 3.0](http://ijcsit.com/docs/Volume%206/vol6issue03/ijcsit20150603159.pdf)

[2] [ICEEE. Proposal of implementation of the data link layer of PCI-express]


## Junior phase
[3] [IEEE. Design of a Link-Controller architecture for Multiple Serial Link Protocols] 


## Senior phase




### Link Layer


